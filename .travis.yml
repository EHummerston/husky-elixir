language: bash
os:
  - linux
  #- osx # elixir is not available for macOS (might be able to do a workaround installing asdf)
env:
  global:
    - HEX_USERNAME=spencerdcarlson
    - MIX_ENV=test
cache:
  directories:
    - _build
    - deps
    - ${HOME}/.asdf  
before_install: >-
  git init ${TRAVIS_BUILD_DIR}/dev/sandbox &&
  git clone https://github.com/asdf-vm/asdf.git ~/.asdf &&
  (cd ~/.asdf && git checkout "$(git describe --abbrev=0 --tags)") &&
  . ~/.asdf/asdf.sh &&
  asdf plugin-add elixir &&
  asdf plugin-add erlang &&
  travis_wait asdf install &&
  asdf current
install:
  - mix local.rebar --force
  - mix local.hex --force
  - mix deps.get
  - mix compile  
script:
  - mix format --check-formatted
  - mix credo --strict  
  - mix test
deploy:
  provider: script
  script: >-
    git init ${TRAVIS_BUILD_DIR}/../../ &&
    rm -f priv/husky && 
    MIX_ENV=prod mix deps.get &&
    MIX_ENV=prod mix escript.build &&
    MIX_ENV=dev mix hex.publish --yes &&
    git clean -f
  on:
    tags: true
